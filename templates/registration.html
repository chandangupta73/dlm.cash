{% extends 'user_base.html' %}
{% load static %}
{% block body %}

<body class="bg-register">
  <div class="container-fluid my-5">
    <div class="row">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5 mx-auto">
        <div class="card rounded-4">
          <div style="background-color: #865d1a; border-radius: 20px;" class="card-body p-5">
            <div style="display: flex; align-items: center; justify-content: center;" >
              <img src="{% static 'assets/img/logo/logo.png' %}" class="mb-4" width="145" alt="logo">
            </div>
            <h4 style="color: black;" class="fw-bold text-center">Get Started Now</h4>
            <p style="color: wheat;" class="mb-0 text-center">Enter your credentials to create your account</p>

            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            {% endif %}

            <div class="form-body my-4">
              <form id="registrationForm" method="POST" class="row g-3">
                {% csrf_token %}
                <div class="col-12">
                  <input name="name" type="text" class="form-control" placeholder="Full Name *" required>
                </div>

                <div class="col-12">
                  <input name="phone" type="tel" class="form-control" placeholder="Phone Number *" required>
                </div>

                <div class="col-12">
                  <input name="email" type="email" class="form-control" id="inputEmailAddress" placeholder="example@domain.com *" required>
                </div>

                <div class="col-12">
                  <input id="referred_by" name="referred_by" type="text" class="form-control" placeholder="Referral ID / Email (optional)">
                  <div id="referral_result" class="mt-1 small"></div>
                </div>

                <div class="col-12">
                  <div class="input-group" id="show_hide_password">
                    <input name="password" type="password" class="form-control border-end-0" placeholder="Password *" required>
                    <a href="#" style="background-color: white !important;" class="input-group-text bg-transparent">
                      <i class="bi bi-eye-slash-fill"></i>
                    </a>
                  </div>
                </div>
                
                <!-- <div id="form_message" class="alert text-center" style="display: none;"></div> -->
                <div id="form_message" class="alert alert-dismissible text-center" style="display: none;">
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  <span id="form_message_text"></span>
                </div>

                <div class="col-12">
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary">Register</button>
                  </div>
                </div>
                <div class="col-12">
                  <div class="text-start">
                    <p style="color: wheat;" class="mb-0">I have an account !! <a href="{% url 'login' %}"> Login</a></p>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="{% static 'dashboard/assets/js/jquery.min.js' %}"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'assets/js/auth.js' %}"></script>
  <script>
  $(document).ready(function () {
    // Toggle password
    $("#show_hide_password a").on('click', function (e) {
      e.preventDefault();
      const input = $('#show_hide_password input');
      const icon = $('#show_hide_password i');
      const type = input.attr("type") === "password" ? "text" : "password";
      input.attr("type", type);
      icon.toggleClass("bi-eye-fill bi-eye-slash-fill");
    });

    // Validate referral code (optional)
    $('#referred_by').on('blur', function () {
      const referralCode = $(this).val().trim();
      const resultDiv = $('#referral_result');

      if (!referralCode) {
        resultDiv.text('').removeClass();
        return;
      }

      // Basic validation - just show if code exists
      resultDiv.text('Referral code will be validated during registration')
        .removeClass()
        .addClass('text-info small');
    });

    // Handle form submission via AJAX to backend API
    $('#registrationForm').on('submit', function (e) {
      e.preventDefault();
      
      // Collect form data
      const formData = {
        email: $('input[name="email"]').val().trim(),
        username: $('input[name="email"]').val().trim(), // Use email as username
        password: $('input[name="password"]').val(),
        password_confirm: $('input[name="password"]').val(), // Confirm password
        first_name: $('input[name="name"]').val().split(' ')[0] || $('input[name="name"]').val(), // First name
        last_name: $('input[name="name"]').val().split(' ').slice(1).join(' ') || '', // Last name
        phone_number: $('input[name="phone"]').val().trim(),
        referral_code: $('input[name="referred_by"]').val().trim() || null // Changed from referred_by to referral_code
      };

      // Debug logging
      console.log('Form Data:', formData);

      const messageBox = $('#form_message');
      const messageText = $('#form_message_text');
      const submitBtn = $(this).find('button[type="submit"]');
      const originalText = submitBtn.text();

      // Basic validation
      if (!formData.email || !formData.password || !formData.first_name || !formData.phone_number) {
        messageText.text('Please fill in all required fields.');
        messageBox.removeClass().addClass('alert alert-danger text-center').show();
        return;
      }

      // Show loading state
      submitBtn.text('Creating Account...').prop('disabled', true);
      messageBox.hide();

      fetch('/api/v1/auth/register/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Response data:', data);
        if (data.user && data.user.id) {
          messageText.text('Registration successful! Please login with your credentials.');
          messageBox.removeClass().addClass('alert alert-success text-center').show();

          // Redirect to login page after success
          setTimeout(() => {
            window.location.href = "{% url 'login' %}";
          }, 2000);
        } else {
          // Handle validation errors from backend
          let errorMsg = 'Registration failed';
          if (data.email) errorMsg += ': ' + data.email[0];
          else if (data.username) errorMsg += ': ' + data.username[0];
          else if (data.password) errorMsg += ': ' + data.password[0];
          else if (data.phone_number) errorMsg += ': ' + data.phone_number[0];
          else if (data.non_field_errors) errorMsg += ': ' + data.non_field_errors[0];
          else if (data.error) errorMsg = data.error;
          
          messageText.text(errorMsg);
          messageBox.removeClass().addClass('alert alert-danger text-center').show();
        }
      })
      .catch(error => {
        console.error('Registration error:', error);
        messageText.text('Registration failed. Please try again.');
        messageBox.removeClass().addClass('alert alert-danger text-center').show();
      })
      .finally(() => {
        // Reset button
        submitBtn.text(originalText).prop('disabled', false);
      });
    });
  });

//referal 


$(document).ready(function () {
    let timeout = null;
    $('#referred_by').on('input', function () {
        clearTimeout(timeout);
        const ref = $(this).val().trim();
        if (ref === '') {
            $('#referral_result').text('').removeClass();
            return;
        }
        timeout = setTimeout(function () {
            $.ajax({
                url: '{% url "validate_referral" %}',
                data: { ref: ref },
                success: function (data) {
                    if (data.status === 'success') {
                        $('#referral_result')
                            .text('✅ User found: ' + data.name)
                            .removeClass()
                            .addClass('text-success small mt-1');
                    } else {
                        $('#referral_result')
                            .text('❌ User not found')
                            .removeClass()
                            .addClass('text-danger small mt-1');
                    }
                },
                error: function () {
                    $('#referral_result')
                        .text('❌ Server error')
                        .removeClass()
                        .addClass('text-danger small mt-1');
                }
            });
        }, 500);
    });
});
</script>




</body>

{% endblock %}

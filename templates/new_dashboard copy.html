{% extends 'user_menu.html' %}
{% load static %}
{% block main %}
<!-- Load auth.js for JWT management -->
<script src="{% static 'assets/js/auth.js' %}"></script>

<!--start main wrapper-->
<main class="main-wrapper">
    <div class="main-content">
        <!--breadcrumb-->
        <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
            <div class="breadcrumb-title pe-3">Dashboard</div>
            <div class="ps-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0 p-0">
                        <li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a></li>
                        <li class="breadcrumb-item active" aria-current="page">Investment Dashboard</li>
                    </ol>
                </nav>
            </div>
        </div>
        <!--end breadcrumb-->

        <!-- Welcome Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h4 class="mb-1" id="welcome-name">Welcome back! 👋</h4>
                                <p class="text-muted mb-0">Manage your investments, KYC verification, and wallets from one place.</p>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-success fs-6" id="user-status">Loading...</div>
                                <p class="text-muted mb-0 mt-1" id="member-since">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg bg-primary bg-opacity-10 rounded">
                                    <i class="material-icons-outlined text-primary fs-1">account_balance_wallet</i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1" id="inr-balance">₹0.00</h4>
                                <p class="text-muted mb-0">INR Balance</p>
                                <small class="text-success" id="inr-status">Active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg bg-success bg-opacity-10 rounded">
                                    <i class="material-icons-outlined text-success fs-1">currency_bitcoin</i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1" id="usdt-balance">0.000000</h4>
                                <p class="text-muted mb-0">USDT Balance</p>
                                <small class="text-success" id="usdt-status">Active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg bg-warning bg-opacity-10 rounded">
                                    <i class="material-icons-outlined text-warning fs-1">verified_user</i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1" id="kyc-status">PENDING</h4>
                                <p class="text-muted mb-0">KYC Status</p>
                                <button class="btn btn-sm btn-outline-primary" onclick="openKYCModal()">Update</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <div class="avatar avatar-lg bg-info bg-opacity-10 rounded">
                                    <i class="material-icons-outlined text-info fs-1">trending_up</i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h4 class="mb-1" id="active-investments">0</h4>
                                <p class="text-muted mb-0">Active Investments</p>
                                <a href="{% url 'plans' %}" class="btn btn-sm btn-outline-info">Invest Now</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-0">
                        <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="wallets-tab" data-bs-toggle="tab" data-bs-target="#wallets" type="button" role="tab">
                                    <i class="material-icons-outlined me-2">account_balance_wallet</i>Wallets
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="investments-tab" data-bs-toggle="tab" data-bs-target="#investments" type="button" role="tab">
                                    <i class="material-icons-outlined me-2">trending_up</i>Investments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="referrals-tab" data-bs-toggle="tab" data-bs-target="#referrals" type="button" role="tab">
                                    <i class="material-icons-outlined me-2">share</i>Referrals
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
                                    <i class="material-icons-outlined me-2">receipt_long</i>Transactions
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="announcements-tab" data-bs-toggle="tab" data-bs-target="#announcements" type="button" role="tab">
                                    <i class="material-icons-outlined me-2">campaign</i>Announcements
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="dashboardTabContent">
                            <!-- Wallets Tab -->
                            <div class="tab-pane fade show active" id="wallets" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">account_balance</i>INR Wallet</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="text-center mb-3">
                                                    <h3 class="text-primary" id="inr-wallet-balance">₹0.00</h3>
                                                    <p class="text-muted">Available Balance</p>
                                                </div>
                                                <div class="d-grid gap-2">
                                                    <button class="btn btn-primary" onclick="openDepositModal()">
                                                        <i class="material-icons-outlined me-2">add</i>Deposit Funds
                                                    </button>
                                                    <button class="btn btn-outline-primary" onclick="openWithdrawModal();">
                                                        <i class="material-icons-outlined me-1">account_balance_wallet</i>
                                                        Withdraw Funds
                                                    </button>
                                                </div>
                                                <hr>
                                                <div id="inr-recent-transactions">
                                                    <h6>Recent Transactions</h6>
                                                    <div class="text-center text-muted">
                                                        <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                        <p>Loading transactions...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header bg-success text-white">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">currency_bitcoin</i>USDT Wallet</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="text-center mb-3">
                                                    <h3 class="text-success" id="usdt-wallet-balance">0.000000</h3>
                                                    <p class="text-muted">Available Balance</p>
                                                </div>

                                                <div id="usdt-wallet-address" class="mb-3">
                                                    <h6>Wallet Address</h6>
                                                    <div class="text-center text-muted">
                                                        <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                        <p>Loading address...</p>
                                                    </div>
                                                </div>
                                                <div id="usdt-recent-transactions">
                                                    <h6>Recent Transactions</h6>
                                                    <div class="text-center text-muted">
                                                        <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                        <p>Loading transactions...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Investments Tab -->
                            <div class="tab-pane fade" id="investments" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">trending_up</i>Active Investments</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="user-investments">
                                                    <div class="text-center text-muted">
                                                        <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                        <p>Loading investments...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">analytics</i>Investment Summary</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between">
                                                        <span>Total Invested:</span>
                                                        <strong id="total-invested">₹0.00</strong>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between">
                                                        <span>Total Returns:</span>
                                                        <strong id="total-returns" class="text-success">₹0.00</strong>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between">
                                                        <span>Active Plans:</span>
                                                        <strong id="active-plans">0</strong>
                                                    </div>
                                                </div>
                                                <a href="{% url 'plans' %}" class="btn btn-primary w-100">
                                                    <i class="material-icons-outlined me-2">add</i>New Investment
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Referrals Tab -->
                            <div class="tab-pane fade" id="referrals" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">people</i>Referral Tree</h6>
                                            </div>
                                            <div class="card-body">
                                                <div id="referral-tree">
                                                    <div class="text-center text-muted">
                                                        <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                        <p>Loading referral tree...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="material-icons-outlined me-2">share</i>Referral Info</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Your Referral Code</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="referral-code" readonly>
                                                        <button class="btn btn-outline-primary" onclick="copyReferralCode()">
                                                            <i class="material-icons-outlined">content_copy</i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Referral Link</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="referral-link" readonly>
                                                        <button class="btn btn-outline-primary" onclick="copyReferralLink()">
                                                            <i class="material-icons-outlined">content_copy</i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <hr>
                                                <div class="text-center">
                                                    <div class="row">
                                                        <div class="col-6">
                                                            <h4 id="total-referrals">0</h4>
                                                            <small>Total Referrals</small>
                                                        </div>
                                                        <div class="col-6">
                                                            <h4 id="referral-earnings" class="text-success">₹0.00</h4>
                                                            <small>Earnings</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Transactions Tab -->
                            <div class="tab-pane fade" id="transactions" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="material-icons-outlined me-2">receipt_long</i>Transaction History</h6>
                                            <div class="d-flex gap-2">
                                                <select class="form-select form-select-sm" id="transaction-filter">
                                                    <option value="">All Types</option>
                                                    <option value="DEPOSIT">Deposits</option>
                                                    <option value="WITHDRAWAL">Withdrawals</option>
                                                    <option value="INVESTMENT">Investments</option>
                                                    <option value="ROI">ROI</option>
                                                    <option value="REFERRAL">Referral</option>
                                                </select>
                                                <button class="btn btn-sm btn-primary" onclick="refreshTransactions()">
                                                    <i class="material-icons-outlined">refresh</i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div id="transactions-list">
                                            <div class="text-center text-muted">
                                                <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                <p>Loading transactions...</p>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-center mt-3">
                                            <nav id="transaction-pagination">
                                                <!-- Pagination will be loaded here -->
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Announcements Tab -->
                            <div class="tab-pane fade" id="announcements" role="tabpanel">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="material-icons-outlined me-2">campaign</i>System Announcements</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="announcements-list">
                                            <div class="text-center text-muted">
                                                <i class="material-icons-outlined fs-1">hourglass_empty</i>
                                                <p>Loading announcements...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KYC Status Alert -->
        <div class="row mb-4" id="kyc-alert-container">
            <!-- KYC alerts will be dynamically inserted here -->
        </div>
    </div>
</main>
<!--end main wrapper-->

<!-- KYC Modal -->
<div class="modal fade" id="kycModal" tabindex="-1" aria-labelledby="kycModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="kycModalLabel">
                    <i class="material-icons-outlined text-primary me-2">verified_user</i>
                    KYC Verification
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="kycForm" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="documentType" class="form-label">Document Type *</label>
                            <select class="form-select" id="documentType" name="document_type" required>
                                <option value="">Select Document Type</option>
                                <option value="PAN">PAN Card</option>
                                <option value="AADHAAR">Aadhaar Card</option>
                                <option value="PASSPORT">Passport</option>
                                <option value="DRIVING_LICENSE">Driving License</option>
                                <option value="VOTER_ID">Voter ID</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="documentNumber" class="form-label">Document Number</label>
                            <input type="text" class="form-control" id="documentNumber" name="document_number" placeholder="Enter document number">
                        </div>
                        <div class="col-12">
                            <label for="documentFile" class="form-label">Document File *</label>
                            <input type="file" class="form-control" id="documentFile" name="document_file" accept=".pdf,.jpg,.jpeg,.png" required>
                            <div class="form-text">Accepted formats: PDF, JPG, JPEG, PNG (Max 5MB)</div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitKYC()">
                    <i class="material-icons-outlined me-1">upload</i>Upload Document
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Deposit Modal -->
<div class="modal fade" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="depositModalLabel">
                    <i class="material-icons-outlined text-primary me-2">add</i>
                    Deposit Funds
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="depositForm">
                    <!-- Currency Selection -->
                    <div class="mb-3">
                        <label for="depositCurrency" class="form-label">Currency *</label>
                        <select class="form-select" id="depositCurrency" name="currency" required onchange="handleDepositCurrencyChange()">
                            <option value="">Select Currency</option>
                            <option value="INR">INR (Indian Rupee)</option>
                            <option value="USDT">USDT (Tether USD)</option>
                        </select>
                    </div>

                    <!-- INR Deposit Form -->
                    <div id="inrDepositForm" style="display: none;">
                        <div class="mb-3">
                            <label for="depositAmount" class="form-label">Amount (INR) *</label>
                            <input type="number" class="form-control" id="depositAmount" name="amount" min="100" step="0.01" required>
                            <div class="form-text">Minimum deposit: ₹100</div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="paymentMethod" name="payment_method" required onchange="handlePaymentMethodChange()">
                                <option value="">Select Payment Method</option>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="upi">UPI</option>
                                <option value="razorpay">Razorpay</option>
                            </select>
                        </div>
                        <div id="bankDetails" style="display: none;">
                            <h6 class="mb-3 text-primary">Bank Account Details</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="accountNumber" class="form-label">Account Number *</label>
                                    <input type="text" class="form-control" id="accountNumber" name="account_number">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ifscCode" class="form-label">IFSC Code *</label>
                                    <input type="text" class="form-control" id="ifscCode" name="ifsc_code">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="accountHolderName" class="form-label">Account Holder Name *</label>
                                    <input type="text" class="form-control" id="accountHolderName" name="account_holder_name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="bankName" class="form-label">Bank Name *</label>
                                    <input type="text" class="form-control" id="bankName" name="bank_name">
                                </div>
                            </div>
                        </div>
                        <div id="upiDetails" style="display: none;">
                            <h6 class="mb-3 text-primary">UPI Details</h6>
                            <div class="mb-3">
                                <label for="upiId" class="form-label">UPI ID *</label>
                                <input type="text" class="form-control" id="upiId" name="upi_id" placeholder="example@upi">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="referenceNumber" class="form-label">Reference Number</label>
                            <input type="text" class="form-control" id="referenceNumber" name="reference_number" placeholder="Transaction ID or Reference">
                        </div>
                        <div class="mb-3">
                            <label for="depositNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="depositNotes" name="notes" rows="2" placeholder="Any additional notes..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="screenshot" class="form-label">Payment Screenshot</label>
                            <input type="file" class="form-control" id="screenshot" name="screenshot" accept="image/*">
                            <div class="form-text">Upload screenshot of payment confirmation</div>
                        </div>
                    </div>

                    <!-- USDT Deposit Form -->
                    <div id="usdtDepositForm" style="display: none;">
                        <div class="mb-3">
                            <label for="usdtAmount" class="form-label">Amount (USDT) *</label>
                            <input type="number" class="form-control" id="usdtAmount" name="usdt_amount" min="0.000001" step="0.000001" required>
                            <div class="form-text">Minimum deposit: 0.000001 USDT</div>
                        </div>
                        <div class="mb-3">
                            <label for="chainType" class="form-label">Blockchain Network *</label>
                            <select class="form-select" id="chainType" name="chain_type" required onchange="handleChainTypeChange()">
                                <option value="">Select Network</option>
                                <option value="erc20">ERC20 (Ethereum)</option>
                                <option value="bep20">BEP20 (Binance Smart Chain)</option>
                                <option value="trc20">TRC20 (Tron)</option>
                            </select>
                        </div>
                        <div id="usdtWalletInfo" style="display: none;">
                            <div class="alert alert-info">
                                <h6 class="mb-2"><i class="material-icons-outlined me-2">info</i>Your USDT Wallet Address</h6>
                                <div id="usdtWalletAddress" class="mb-2">
                                    <code class="fs-6" id="displayWalletAddress">Loading...</code>
                                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="copyWalletAddress()">
                                        <i class="material-icons-outlined">content_copy</i>
                                    </button>
                                </div>
                                <small class="text-muted">Send USDT to this address on the selected network. Transaction will be processed automatically after confirmations.</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="transactionHash" class="form-label">Transaction Hash</label>
                            <input type="text" class="form-control" id="transactionHash" name="transaction_hash" placeholder="Optional: Enter transaction hash for manual processing">
                            <div class="form-text">Leave empty for automatic processing via webhook</div>
                        </div>
                        <div class="mb-3">
                            <label for="fromAddress" class="form-label">From Address</label>
                            <input type="text" class="form-control" id="fromAddress" name="from_address" placeholder="Optional: Sender's wallet address">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitDeposit()">
                    <i class="material-icons-outlined me-1">send</i>Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div class="modal fade" id="withdrawModal" tabindex="-1" aria-labelledby="withdrawModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawModalLabel">
                    <i class="material-icons-outlined text-danger me-2">send</i>
                    Withdraw Funds
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="withdrawForm">
                    <!-- Currency Selection -->
                    <div class="mb-3">
                        <label for="withdrawCurrency" class="form-label">Currency *</label>
                        <select class="form-select" id="withdrawCurrency" name="currency" required onchange="handleCurrencyChange()">
                            <option value="">Select Currency</option>
                            <option value="INR">INR (Indian Rupee)</option>
                            <option value="USDT">USDT (Tether USD)</option>
                        </select>
                    </div>
                    
                    <!-- Amount Field -->
                    <div class="mb-3">
                        <label for="withdrawAmount" class="form-label">Amount *</label>
                        <input type="number" class="form-control" id="withdrawAmount" name="amount" min="100" step="0.000001" required>
                        <div class="form-text" id="amountHelpText">Minimum withdrawal: ₹100</div>
                    </div>
                    
                    <!-- Payout Method Selection -->
                    <div class="mb-3">
                        <label for="withdrawPayoutMethod" class="form-label">Payout Method *</label>
                        <select name="payout_method" class="form-select" id="withdrawPayoutMethod">
                            <option value="">Select Payout Method</option>
                            <!-- INR Options -->
                            <option value="bank_transfer" data-currency="INR">Bank Transfer</option>
                            <option value="upi_transfer" data-currency="UPI">UPI Transfer</option>
                            <!-- USDT Options -->
                            <option value="usdt_erc20" data-currency="USDT">USDT ERC20 (Ethereum)</option>
                            <option value="usdt_bep20" data-currency="USDT">USDT BEP20 (Binance Smart Chain)</option>
                            <option value="usdt_trc20" data-currency="USDT">USDT TRC20 (Tron)</option>
                        </select>
                    </div>
                    
                    <!-- INR Bank Details Section -->
                    <div id="withdrawBankDetails" style="display: none;">
                        <h6 class="mb-3 text-primary">Bank Account Details</h6>
                        <div id="savedBankDetails">
                            <div class="alert alert-info">
                                <i class="material-icons-outlined me-2">info</i>
                                <strong>Note:</strong> Using your saved bank account details for this withdrawal.
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Account Number</label>
                                    <div class="form-control" id="displayAccountNumber">Loading...</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">IFSC Code</label>
                                    <div class="form-control" id="displayIfscCode">Loading...</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Account Holder Name</label>
                                    <div class="form-control" id="displayAccountHolderName">Loading...</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Bank Name</label>
                                    <div class="form-control" id="displayBankName">Loading...</div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <a href="{% url 'profile' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="material-icons-outlined me-1">settings</i>
                                    Update Bank Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- USDT Wallet Details Section -->
                    <div id="withdrawUSDTDetails" style="display: none;">
                        <h6 class="mb-3 text-success">USDT Wallet Details</h6>
                        <div id="usdtWalletInfo">
                            <div class="alert alert-info">
                                <i class="material-icons-outlined me-2">info</i>
                                <strong>Note:</strong> USDT withdrawals will be sent to your saved wallet address.
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Network</label>
                                    <div class="form-control" id="displayUSDTNetwork">Not configured</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Wallet Address</label>
                                    <div class="form-control" id="displayUSDTAddress">Not configured</div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="loadUSDTWalletDetails()">
                                        <i class="material-icons-outlined me-1">refresh</i>
                                        Refresh USDT Details
                                    </button>

                                    <a href="{% url 'usdt-details' %}" class="btn btn-outline-success btn-sm">
                                        <i class="material-icons-outlined me-1">settings</i>
                                        Configure USDT Wallet
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitWithdraw()">
                    <i class="material-icons-outlined me-1">send</i>Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<!-- JavaScript for Dashboard -->
<script>
// Global variables
let currentPage = 1;
let transactionFilter = '';

// Initialize dashboard on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    setupEventListeners();
    
    // Add event listener for payout method change
    const payoutMethodSelect = document.getElementById('withdrawPayoutMethod');
    if (payoutMethodSelect) {
        payoutMethodSelect.addEventListener('change', handlePayoutMethodChange);
        console.log('✅ Event listener added for payout method change');
    } else {
        console.error('❌ Payout method select not found');
    }
});

function initializeDashboard() {
    loadUserProfile();
    loadWalletBalances();
    loadKYCStatus();
    loadInvestments();
    loadReferralData();
    loadTransactions();
    loadAnnouncements();
}

function setupEventListeners() {
    // Payment method change
    document.getElementById('paymentMethod').addEventListener('change', function() {
        const bankDetails = document.getElementById('bankDetails');
        if (this.value === 'bank_transfer') {
            bankDetails.style.display = 'block';
        } else {
            bankDetails.style.display = 'none';
        }
    });

    // Transaction filter
    document.getElementById('transaction-filter').addEventListener('change', function() {
        transactionFilter = this.value;
        currentPage = 1;
        loadTransactions();
    });

    // Tab change events
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('data-bs-target');
            handleTabChange(targetId);
        });
    });
}

function handleTabChange(targetId) {
    switch(targetId) {
        case '#wallets':
            loadWalletBalances();
            break;
        case '#investments':
            loadInvestments();
            break;
        case '#referrals':
            loadReferralData();
            break;
        case '#transactions':
            loadTransactions();
            break;
        case '#announcements':
            loadAnnouncements();
            break;
    }
}

// API Integration Functions
async function loadUserProfile() {
    const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
    if (userData.first_name) {
        document.getElementById('welcome-name').textContent = `Welcome back, ${userData.first_name}! 👋`;
    }
    
    document.getElementById('user-status').textContent = 'Active User';
    document.getElementById('member-since').textContent = 'Member since ' + new Date().toLocaleDateString();
}

async function loadWalletBalances() {
    try {
        showLoading('Loading wallet balances...');
        const response = await apiRequest('/api/v1/wallet/balance/');
        const data = await response.json();
        
        if (response.ok) {
            // Update balance displays
            const inrBalance = parseFloat(data.inr_wallet?.balance || 0).toFixed(2);
            const usdtBalance = parseFloat(data.usdt_wallet?.balance || 0).toFixed(6);
            
            document.getElementById('inr-balance').textContent = `₹${inrBalance}`;
            document.getElementById('usdt-balance').textContent = usdtBalance;
            document.getElementById('inr-wallet-balance').textContent = `₹${inrBalance}`;
            document.getElementById('usdt-wallet-balance').textContent = usdtBalance;
            
            // Update status
            document.getElementById('inr-status').textContent = data.inr_wallet?.is_active ? 'Active' : 'Inactive';
            document.getElementById('usdt-status').textContent = data.usdt_wallet?.is_active ? 'Active' : 'Inactive';
            
            hideLoading();
        } else {
            throw new Error(data.detail || 'Failed to load wallet balances');
        }
    } catch (error) {
        console.error('Error loading wallet balances:', error);
        showError('Failed to load wallet balances: ' + error.message);
        hideLoading();
    }
}

async function loadWalletAddresses() {
    try {
        const response = await apiRequest('/api/v1/wallet/addresses/');
        const data = await response.json();
        
        if (response.ok && (data.erc20 || data.bep20)) {
            const addressDiv = document.getElementById('usdt-wallet-address');
            let addressHtml = '';
            
            if (data.erc20) {
                addressHtml += `
                    <h6>ERC20 Address (USDT)</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" value="${data.erc20}" readonly>
                        <button class="btn btn-outline-success" onclick="copyToClipboard('${data.erc20}')">
                            <i class="material-icons-outlined">content_copy</i>
                        </button>
                    </div>
                `;
            }
            
            if (data.bep20) {
                addressHtml += `
                    <h6>BEP20 Address (USDT)</h6>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" value="${data.bep20}" readonly>
                        <button class="btn btn-outline-success" onclick="copyToClipboard('${data.bep20}')">
                            <i class="material-icons-outlined">content_copy</i>
                        </button>
                    </div>
                `;
            }
            
            addressDiv.innerHTML = addressHtml + `
                <div class="alert alert-info">
                    <i class="material-icons-outlined me-2">info</i>
                    <small>Use these addresses to deposit USDT to your wallet. Only send USDT tokens to these addresses.</small>
                </div>
            `;
        } else {
            document.getElementById('usdt-wallet-address').innerHTML = `
                <h6>Wallet Addresses</h6>
                <div class="text-center text-muted py-3">
                    <i class="material-icons-outlined fs-1">error_outline</i>
                    <p>Unable to load wallet addresses. Please contact support if this persists.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading wallet addresses:', error);
    }
}

async function loadKYCStatus() {
    try {
        // Fetch real-time KYC status from backend API
        const response = await apiRequest('/api/v1/kyc/status/');
        const data = await response.json();
        
        let kycStatus = 'PENDING'; // Default status
        
        if (response.ok && data) {
            console.log('KYC Status API Response:', data);
            
            // Use the overall_kyc_status from API response
            kycStatus = data.overall_kyc_status || 'PENDING';
            
            console.log('Final KYC Status:', kycStatus);
        } else {
            console.error('KYC Status API Error:', data);
        }
        
        // Update KYC status display
        document.getElementById('kyc-status').textContent = kycStatus;
        
        // Update color based on status
        const kycCard = document.querySelector('#kyc-status').closest('.card-body');
        const avatar = kycCard.querySelector('.avatar');
        const icon = kycCard.querySelector('i');
        
        if (avatar && icon) {
            avatar.className = avatar.className.replace(/bg-\w+-bg-opacity-10/, '');
            icon.className = icon.className.replace(/text-\w+/, '');
            
            switch(kycStatus) {
                case 'APPROVED':
                    avatar.classList.add('bg-success-bg-opacity-10');
                    icon.classList.add('text-success');
                    showKYCAlert('success', 'KYC Verified! Your account is fully verified.');
                    break;
                case 'REJECTED':
                    avatar.classList.add('bg-danger-bg-opacity-10');
                    icon.classList.add('text-danger');
                    showKYCAlert('danger', 'KYC Rejected. Please resubmit your documents.');
                    break;
                default:
                    avatar.classList.add('bg-warning-bg-opacity-10');
                    icon.classList.add('text-warning');
                    showKYCAlert('warning', 'KYC Pending. Please complete your verification to access all features.');
            }
        }
    } catch (error) {
        console.error('Error loading KYC status:', error);
    }
}

async function loadInvestments() {
    try {
        showTabLoading('investments');
        const response = await apiRequest('/api/v1/investment/investments/');
        const data = await response.json();
        
        if (response.ok) {
            const investments = data.results || [];
            updateInvestmentsDisplay(investments);
            
            // Update summary with proper status checking and currency conversion
            let totalInvested = 0;
            let activeCount = 0;
            
            investments.forEach(inv => {
                const amount = parseFloat(inv.amount || 0);
                const status = inv.status?.toLowerCase();
                
                // Count active investments (case-insensitive)
                if (status === 'active') {
                    activeCount++;
                }
                
                // Calculate total invested (convert USDT to INR for consistency)
                if (inv.currency?.toLowerCase() === 'usdt') {
                    totalInvested += amount * 83; // Convert USDT to INR (1 USDT = ₹83)
                } else {
                    totalInvested += amount; // INR stays as is
                }
            });
            
            // Debug logging
            console.log('=== DASHBOARD INVESTMENT SUMMARY ===');
            console.log('Total Investments:', investments.length);
            console.log('Active Count:', activeCount);
            console.log('Total Invested (INR):', totalInvested);
            console.log('Investments Data:', investments);
            
            document.getElementById('active-investments').textContent = activeCount;
            document.getElementById('total-invested').textContent = `₹${totalInvested.toFixed(2)}`;
            document.getElementById('active-plans').textContent = activeCount;
            
            // Always hide loading regardless of whether there are investments
            hideTabLoading('investments');
        } else {
            throw new Error(data.detail || 'Failed to load investments');
        }
    } catch (error) {
        console.error('Error loading investments:', error);
        document.getElementById('user-investments').innerHTML = `
            <div class="text-center text-danger">
                <i class="material-icons-outlined fs-1">error</i>
                <p>Failed to load investments</p>
            </div>
        `;
        hideTabLoading('investments');
    }
}

async function loadReferralData() {
    try {
        showTabLoading('referrals');
        const response = await apiRequest('/api/v1/referrals/profile/');
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('referral-code').value = data.referral_code || 'N/A';
            document.getElementById('referral-link').value = data.referral_link || window.location.origin + '/auth/sign-up?ref=' + (data.referral_code || '');
            document.getElementById('total-referrals').textContent = data.total_referrals || 0;
            document.getElementById('referral-earnings').textContent = `₹${parseFloat(data.total_earnings || 0).toFixed(2)}`;
            
            // Load referral tree
            loadReferralTree();
            hideTabLoading('referrals');
        } else {
            throw new Error(data.detail || 'Failed to load referral data');
        }
    } catch (error) {
        console.error('Error loading referral data:', error);
        hideTabLoading('referrals');
    }
}

async function loadReferralTree() {
    try {
        const response = await apiRequest('/api/v1/referrals/tree/');
        const data = await response.json();
        
        if (response.ok) {
            const treeDiv = document.getElementById('referral-tree');
            
            if (data.referrals && data.referrals.length > 0) {
                let treeHtml = '<div class="list-group">';
                data.referrals.forEach(referral => {
                    treeHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${referral.username || referral.email}</h6>
                                    <small class="text-muted">Joined: ${new Date(referral.joined_at).toLocaleDateString()}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">Level 1</span>
                            </div>
                        </div>
                    `;
                });
                treeHtml += '</div>';
                treeDiv.innerHTML = treeHtml;
            } else {
                treeDiv.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="material-icons-outlined fs-1">people</i>
                        <p>No referrals yet. Start inviting friends!</p>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading referral tree:', error);
    }
}

async function loadTransactions(page = 1) {
    try {
        showTabLoading('transactions');
        let url = `/api/v1/transactions/?page=${page}`;
        if (transactionFilter) {
            url += `&transaction_type=${transactionFilter}`;
        }
        
        const response = await apiRequest(url);
        const data = await response.json();
        
        if (response.ok) {
            updateTransactionsDisplay(data.results || []);
            updatePagination(data, 'transaction-pagination');
            hideTabLoading('transactions');
        } else {
            throw new Error(data.detail || 'Failed to load transactions');
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
        document.getElementById('transactions-list').innerHTML = `
            <div class="text-center text-danger">
                <i class="material-icons-outlined fs-1">error</i>
                <p>Failed to load transactions</p>
            </div>
        `;
        hideTabLoading('transactions');
    }
}

async function loadAnnouncements() {
    try {
        showTabLoading('announcements');
        const response = await apiRequest('/api/v1/admin/announcements/user/');
        const data = await response.json();
        
        if (response.ok) {
            // Check if data is an array (direct) or has results property
            const announcements = Array.isArray(data) ? data : (data.results || []);
            updateAnnouncementsDisplay(announcements);
            hideTabLoading('announcements');
        } else {
            throw new Error(data.detail || 'Failed to load announcements');
        }
    } catch (error) {
        console.error('Error loading announcements:', error);
        document.getElementById('announcements-list').innerHTML = `
            <div class="text-center text-muted">
                <i class="material-icons-outlined fs-1">campaign</i>
                <p>No announcements available</p>
            </div>
        `;
        hideTabLoading('announcements');
    }
}

// Display Update Functions
function updateInvestmentsDisplay(investments) {
    const container = document.getElementById('user-investments');
    
    if (investments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="material-icons-outlined fs-1">trending_up</i>
                <p>No active investments</p>
                <a href="{% url 'plans' %}" class="btn btn-primary">Start Investing</a>
            </div>
        `;
        return;
    }
    
    let html = '<div class="row">';
    investments.forEach(investment => {
                                        const statusColor = investment.status?.toLowerCase() === 'active' ? 'success' : 
                    investment.status?.toLowerCase() === 'cancelled' ? 'danger' : 'warning';
        
        html += `
            <div class="col-md-6 mb-3">
                <div class="card border">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">${investment.plan_name || investment.plan?.name || 'Investment Plan'}</h6>
                            <span class="badge bg-${statusColor}">${investment.status}</span>
                        </div>
                        <p class="text-muted mb-2">
                            Amount: <strong>₹${parseFloat(investment.amount).toFixed(2)}</strong><br>
                                                    ROI: <strong>${investment.plan_roi_rate || 0}%</strong><br>
                        Duration: <strong>${investment.plan_frequency || 'Daily'} ROI</strong>
                        </p>
                        <div class="progress mb-2" style="height: 5px;">
                            <div class="progress-bar bg-${statusColor}" 
                                 style="width: ${calculateProgress(investment)}%"></div>
                        </div>
                        <small class="text-muted">
                            ${investment.start_date ? 'Started: ' + new Date(investment.start_date).toLocaleDateString() : ''}
                            ${investment.maturity_date ? ' | Matures: ' + new Date(investment.maturity_date).toLocaleDateString() : ''}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

function updateTransactionsDisplay(transactions) {
    const container = document.getElementById('transactions-list');
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="material-icons-outlined fs-1">receipt_long</i>
                <p>No transactions found</p>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Currency</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Balance After</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    transactions.forEach(tx => {
        const statusColor = getStatusColor(tx.status);
        const typeIcon = getTransactionIcon(tx.transaction_type);
        
        html += `
            <tr>
                <td>
                    <i class="material-icons-outlined me-2">${typeIcon}</i>
                    ${tx.transaction_type || 'Unknown'}
                </td>
                <td class="${tx.transaction_type === 'WITHDRAWAL' ? 'text-danger' : 'text-success'}">
                    ${tx.transaction_type === 'WITHDRAWAL' ? '-' : '+'}₹${parseFloat(tx.amount || 0).toFixed(2)}
                </td>
                <td>${tx.currency || 'INR'}</td>
                <td><span class="badge bg-${statusColor}">${tx.status || 'Unknown'}</span></td>
                <td>${new Date(tx.created_at).toLocaleDateString()}</td>
                <td>₹${parseFloat(tx.balance_after || 0).toFixed(2)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function updateAnnouncementsDisplay(announcements) {
    const container = document.getElementById('announcements-list');
    
    if (announcements.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted">
                <i class="material-icons-outlined fs-1">campaign</i>
                <p>No announcements available</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    announcements.forEach(announcement => {
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title">${announcement.title}</h6>
                    <p class="card-text">${announcement.message}</p>
                    <small class="text-muted">
                        <i class="material-icons-outlined me-1">schedule</i>
                        ${new Date(announcement.created_at).toLocaleDateString()}
                    </small>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Modal Functions
function openKYCModal() {
    new bootstrap.Modal(document.getElementById('kycModal')).show();
}

function openDepositModal() {
    // Reset form and hide all sections
    document.getElementById('depositForm').reset();
    document.getElementById('inrDepositForm').style.display = 'none';
    document.getElementById('usdtDepositForm').style.display = 'none';
    document.getElementById('usdtWalletInfo').style.display = 'none';
    
    new bootstrap.Modal(document.getElementById('depositModal')).show();
}

// Handle deposit currency change
function handleDepositCurrencyChange() {
    const currency = document.getElementById('depositCurrency').value;
    const inrForm = document.getElementById('inrDepositForm');
    const usdtForm = document.getElementById('usdtDepositForm');
    
    // Hide both forms initially
    inrForm.style.display = 'none';
    usdtForm.style.display = 'none';
    
    if (currency === 'INR') {
        inrForm.style.display = 'block';
    } else if (currency === 'USDT') {
        usdtForm.style.display = 'block';
    }
}

// Handle payment method change for INR
function handlePaymentMethodChange() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const bankDetails = document.getElementById('bankDetails');
    const upiDetails = document.getElementById('upiDetails');
    
    // Hide all detail sections
    bankDetails.style.display = 'none';
    upiDetails.style.display = 'none';
    
    if (paymentMethod === 'bank_transfer') {
        bankDetails.style.display = 'block';
    } else if (paymentMethod === 'upi') {
        upiDetails.style.display = 'block';
    }
}

// Handle chain type change for USDT
async function handleChainTypeChange() {
    const chainType = document.getElementById('chainType').value;
    const walletInfo = document.getElementById('usdtWalletInfo');
    const walletAddress = document.getElementById('displayWalletAddress');
    
    if (!chainType) {
        walletInfo.style.display = 'none';
        return;
    }
    
    try {
        // Get wallet address for the selected chain
        const response = await apiRequest(`/api/v1/wallet/address/${chainType}/`, {
            method: 'GET'
        });
        
        if (response.ok) {
            const data = await response.json();
            walletAddress.textContent = data.address;
            walletInfo.style.display = 'block';
        } else {
            throw new Error('Failed to get wallet address');
        }
    } catch (error) {
        console.error('Error getting wallet address:', error);
        showError('Failed to get wallet address for selected network');
        walletInfo.style.display = 'none';
    }
}

// Copy wallet address to clipboard
function copyWalletAddress() {
    const walletAddress = document.getElementById('displayWalletAddress').textContent;
    navigator.clipboard.writeText(walletAddress).then(() => {
        showSuccess('Wallet address copied to clipboard!');
    }).catch(() => {
        showError('Failed to copy wallet address');
    });
}

// Open withdraw modal and load saved details
function openWithdrawModal() {
    // Reset form
    document.getElementById('withdrawForm').reset();
    
    // Hide all detail sections
    document.getElementById('withdrawBankDetails').style.display = 'none';
    document.getElementById('withdrawUSDTDetails').style.display = 'none';
    
    // Reset amount help text
    document.getElementById('amountHelpText').textContent = 'Minimum withdrawal: ₹100';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('withdrawModal'));
    modal.show();
    
    // Load details after modal is shown
    setTimeout(() => {
        loadSavedDetails();
    }, 300);
}

// Load saved details when modal opens
async function loadSavedDetails() {
    try {
        // Load bank details
        await loadBankDetails();
        
        // USDT details will be loaded when USDT payout method is selected
    } catch (error) {
        console.error('Error loading saved details:', error);
    }
}

// Form Submission Functions
async function submitKYC() {
    const form = document.getElementById('kycForm');
    const formData = new FormData();
    
    const documentType = document.getElementById('documentType').value;
    const documentNumber = document.getElementById('documentNumber').value;
    const documentFile = document.getElementById('documentFile').files[0];
    
    if (!documentType || !documentFile) {
        showError('Please provide document type and file');
        return;
    }
    
    formData.append('document_type', documentType);
    formData.append('document_number', documentNumber);
    formData.append('document_file', documentFile);
    
    try {
        showLoading('Uploading KYC document...');
        const response = await fetch('/api/v1/kyc/documents/upload/', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${AuthManager.getAccessToken()}`
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('KYC document uploaded successfully!');
            bootstrap.Modal.getInstance(document.getElementById('kycModal')).hide();
            form.reset();
            loadKYCStatus();
        } else {
            throw new Error(data.detail || data.error || 'KYC upload failed');
        }
    } catch (error) {
        console.error('Error submitting KYC:', error);
        showError('KYC upload failed: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function submitDeposit() {
    const form = document.getElementById('depositForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const currency = formData.get('currency');
    
    if (currency === 'INR') {
        await submitINRDeposit(formData);
    } else if (currency === 'USDT') {
        await submitUSDTDeposit(formData);
    } else {
        showError('Please select a valid currency');
        return;
    }
}

async function submitINRDeposit(formData) {
    const data = {
        amount: formData.get('amount'),
        payment_method: formData.get('payment_method'),
        reference_number: formData.get('reference_number'),
        notes: formData.get('notes')
    };
    
    // Add payment method specific details
    const paymentMethod = formData.get('payment_method');
    if (paymentMethod === 'bank_transfer') {
        data.payment_details = {
            account_number: formData.get('account_number'),
            ifsc_code: formData.get('ifsc_code'),
            account_holder_name: formData.get('account_holder_name'),
            bank_name: formData.get('bank_name')
        };
    } else if (paymentMethod === 'upi') {
        data.payment_details = {
            upi_id: formData.get('upi_id')
        };
    }
    
    try {
        showLoading('Creating INR deposit request...');
        
        // Handle file upload if screenshot is provided
        if (formData.get('screenshot')) {
            const fileFormData = new FormData();
            fileFormData.append('amount', data.amount);
            fileFormData.append('payment_method', data.payment_method);
            fileFormData.append('reference_number', data.reference_number || '');
            fileFormData.append('notes', data.notes || '');
            fileFormData.append('screenshot', formData.get('screenshot'));
            
            // Add payment details as JSON string
            if (data.payment_details) {
                fileFormData.append('payment_details', JSON.stringify(data.payment_details));
            }
            
            const response = await apiRequest('/api/v1/deposit-requests/', {
                method: 'POST',
                body: fileFormData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess('INR deposit request created successfully!');
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
                document.getElementById('depositForm').reset();
                loadWalletBalances();
                loadTransactions();
            } else {
                throw new Error(result.detail || result.error || 'INR deposit request failed');
            }
        } else {
            // No file upload, send JSON
            const response = await apiRequest('/api/v1/deposit-requests/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess('INR deposit request created successfully!');
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
                document.getElementById('depositForm').reset();
                loadWalletBalances();
                loadTransactions();
            } else {
                throw new Error(result.detail || result.error || 'INR deposit request failed');
            }
        }
    } catch (error) {
        console.error('Error submitting INR deposit:', error);
        showError('INR deposit request failed: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function submitUSDTDeposit(formData) {
    const data = {
        amount: formData.get('usdt_amount'),
        chain_type: formData.get('chain_type'),
        transaction_hash: formData.get('transaction_hash') || '',
        from_address: formData.get('from_address') || '',
        to_address: '' // Will be filled from wallet address
    };
    
    try {
        showLoading('Processing USDT deposit...');
        
        // Get wallet address for the selected chain
        const addressResponse = await apiRequest(`/api/v1/wallet/address/${data.chain_type}/`, {
            method: 'GET'
        });
        
        if (!addressResponse.ok) {
            throw new Error('Failed to get wallet address');
        }
        
        const addressData = await addressResponse.json();
        data.to_address = addressData.address;
        
        // If transaction hash is provided, process manually
        if (data.transaction_hash) {
            const response = await apiRequest('/api/v1/usdt/process-deposit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    from_address: data.from_address,
                    to_address: data.to_address,
                    amount: data.amount,
                    tx_hash: data.transaction_hash,
                    chain_type: data.chain_type,
                    confirmations: 1
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showSuccess('USDT deposit processed successfully!');
                bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
                document.getElementById('depositForm').reset();
                loadWalletBalances();
                loadTransactions();
            } else {
                throw new Error(result.detail || result.error || 'USDT deposit processing failed');
            }
        } else {
            // No transaction hash - show success message for manual deposit
            showSuccess(`USDT deposit address ready! Send ${data.amount} USDT to the displayed address on ${data.chain_type.toUpperCase()} network. Transaction will be processed automatically.`);
            bootstrap.Modal.getInstance(document.getElementById('depositModal')).hide();
            document.getElementById('depositForm').reset();
        }
    } catch (error) {
        console.error('Error submitting USDT deposit:', error);
        showError('USDT deposit failed: ' + error.message);
    } finally {
        hideLoading();
    }
}

async function submitWithdraw() {
    const form = document.getElementById('withdrawForm');
    const formData = new FormData(form);
    
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Check KYC status first
    try {
        const kycResponse = await apiRequest('/api/v1/kyc/status/', {
            method: 'GET'
        });
        
        console.log('KYC Response:', kycResponse);
        console.log('KYC Response Status:', kycResponse.status);
        
        if (kycResponse.ok) {
            const kycData = await kycResponse.json();
            console.log('KYC Data:', kycData);
            console.log('KYC Status:', kycData.overall_kyc_status);
            
            if (kycData.overall_kyc_status !== 'APPROVED') {
                // Show error but allow user to continue for testing
                const shouldContinue = confirm(`KYC Status: ${kycData.overall_kyc_status}\n\nFor testing purposes, you can continue with withdrawal. Click OK to continue or Cancel to stop.`);
                if (!shouldContinue) {
                    return;
                }
                console.warn('KYC check bypassed for testing');
            }
        } else {
            console.error('KYC Response not OK:', kycResponse.status, kycResponse.statusText);
            // Temporarily skip KYC check if API fails
            console.warn('Skipping KYC check due to API failure');
        }
    } catch (error) {
        console.error('Error checking KYC status:', error);
        // Temporarily skip KYC check if there's an error
        console.warn('Skipping KYC check due to error');
    }
    
    const currency = formData.get('currency');
    const amount = parseFloat(formData.get('amount'));
    const payoutMethod = formData.get('payout_method');
    
    // Validate amount
    if (currency === 'INR' && amount < 100) {
        showError('Minimum INR withdrawal amount is ₹100');
        return;
    } else if (currency === 'USDT' && amount < 10) {
        showError('Minimum USDT withdrawal amount is 10 USDT');
        return;
    }
    
    if (isNaN(amount) || amount <= 0) {
        showError('Please enter a valid amount');
        return;
    }

    let data = {};

    if (currency === 'INR') {
        if (payoutMethod === 'bank_transfer') {
            // For bank transfer, we need to get the saved bank details
            try {
                const profileResponse = await apiRequest('/api/v1/profile/', {
                    method: 'GET'
                });
                
                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    if (!profileData.bank_details) {
                        showError('Please configure your bank details first');
                        return;
                    }
                    
                    data = {
                        currency: 'INR',
                        amount: amount,
                        payout_method: payoutMethod,
                        payout_details: {
                            account_number: profileData.bank_details.account_number,
                            ifsc_code: profileData.bank_details.ifsc_code,
                            account_holder_name: profileData.bank_details.account_holder_name,
                            bank_name: profileData.bank_details.bank_name
                        }
                    };
                } else {
                    showError('Failed to load bank details');
                    return;
                }
            } catch (error) {
                console.error('Error loading bank details:', error);
                showError('Failed to load bank details');
                return;
            }
        } else {
            showError('Invalid payout method for INR. Only Bank Transfer is supported.');
            return;
        }
    } else if (currency === 'USDT') {
        // For USDT, we need to get the saved USDT details
        try {
            const usdtResponse = await apiRequest('/api/v1/usdt-details/', {
                method: 'GET'
            });
            
            if (usdtResponse.ok) {
                const usdtDetails = await usdtResponse.json();
                
                // Handle paginated response structure
                const detailsArray = usdtDetails.results || usdtDetails;
                
                if (!detailsArray || detailsArray.length === 0 || !detailsArray[0].wallet_address) {
                    showError('Please configure your USDT wallet details first');
                    return;
                }
                
                const usdtDetail = detailsArray[0];
                
                // Ensure payout method is correctly mapped
                let mappedPayoutMethod = payoutMethod;
                if (payoutMethod === 'usdt_erc20' && usdtDetail.network !== 'erc20') {
                    showError('Selected payout method does not match your saved USDT network');
                    return;
                } else if (payoutMethod === 'usdt_bep20' && usdtDetail.network !== 'bep20') {
                    showError('Selected payout method does not match your saved USDT network');
                    return;
                } else if (payoutMethod === 'usdt_trc20' && usdtDetail.network !== 'trc20') {
                    showError('Selected payout method does not match your saved USDT network');
                    return;
                }
                
                data = {
                    currency: 'USDT',
                    amount: amount,
                    payout_method: mappedPayoutMethod,
                    payout_details: {
                        network: usdtDetail.network,
                        wallet_address: usdtDetail.wallet_address
                    }
                };
            } else {
                showError('Failed to load USDT details');
                return;
            }
        } catch (error) {
            console.error('Error loading USDT details:', error);
            showError('Failed to load USDT details');
            return;
        }
    }
    
    if (!data.currency) {
        console.error('Withdrawal data validation failed:', data);
        showError('Invalid payout method or missing details. Please check your selection and try again.');
        return;
    }
    
    try {
        showLoading('Creating withdrawal request...');
        const response = await apiRequest('/api/v1/withdraw/', {
            method: 'POST',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(`Withdrawal request created! Fee: ₹${result.fee || 0}, Net Amount: ₹${result.net_amount || 0}`);
            bootstrap.Modal.getInstance(document.getElementById('withdrawModal')).hide();
            form.reset();
            loadWalletBalances();
            loadTransactions();
        } else {
            console.error('Withdrawal failed:', result);
            let errorMessage = 'Withdrawal request failed';
            
            if (result.message) {
                errorMessage = result.message;
            } else if (result.detail) {
                errorMessage = result.detail;
            } else if (result.error) {
                errorMessage = result.error;
            } else if (result.errors) {
                // Handle validation errors
                const errorList = Object.entries(result.errors).map(([field, errors]) => {
                    if (Array.isArray(errors)) {
                        return `${field}: ${errors.join(', ')}`;
                    }
                    return `${field}: ${errors}`;
                }).join('; ');
                errorMessage = `Validation errors: ${errorList}`;
            }
            
            console.error('Full error response:', result);
            console.error('Error message:', errorMessage);
            
            throw new Error(errorMessage);
        }
    } catch (error) {
        console.error('Error submitting withdrawal:', error);
        showError('Withdrawal request failed: ' + error.message);
    } finally {
        hideLoading();
    }
}

// Handle currency change in withdraw modal
function handleCurrencyChange() {
    const currency = document.getElementById('withdrawCurrency').value;
    const amountField = document.getElementById('withdrawAmount');
    const amountHelpText = document.getElementById('amountHelpText');
    const payoutMethodSelect = document.getElementById('withdrawPayoutMethod');
    
    // Reset payout method
    payoutMethodSelect.value = '';
    handlePayoutMethodChange();
    
    if (currency === 'INR') {
        amountField.min = '100';
        amountField.step = '1';
        amountHelpText.textContent = 'Minimum withdrawal: ₹100';
    } else if (currency === 'USDT') {
        amountField.min = '10';
        amountField.step = '0.000001';
        amountHelpText.textContent = 'Minimum withdrawal: 10 USDT';
    }
}

// Handle payout method change in withdraw modal
function handlePayoutMethodChange() {
    console.log('🔍 handlePayoutMethodChange called');
    
    const payoutMethod = document.getElementById('withdrawPayoutMethod').value;
    const currencyField = document.getElementById('withdrawCurrency');
    
    console.log('🔍 Payout Method:', payoutMethod);
    
    // Hide all detail sections first
    document.getElementById('withdrawBankDetails').style.display = 'none';
    document.getElementById('withdrawUSDTDetails').style.display = 'none';
    
    // Set currency based on payout method
    if (payoutMethod === 'bank_transfer') {
        currencyField.value = 'INR';
        document.getElementById('withdrawBankDetails').style.display = 'block';
        // Load saved bank details
        loadBankDetails();
    } else if (payoutMethod.startsWith('usdt_')) {
        currencyField.value = 'USDT';
        document.getElementById('withdrawUSDTDetails').style.display = 'block';
        // Load USDT wallet details if available
        console.log('🔍 Loading USDT details...');
        loadUSDTWalletDetails();
    }
}

// Load saved bank details for display in withdraw modal
async function loadBankDetails() {
    try {
        const response = await apiRequest('/api/v1/profile/', {
            method: 'GET'
        });
        
        if (response.ok) {
            const profileData = await response.json();
            if (profileData.bank_details) {
                const bankDetails = profileData.bank_details;
                document.getElementById('displayAccountNumber').textContent = bankDetails.account_number || 'Not configured';
                document.getElementById('displayIfscCode').textContent = bankDetails.ifsc_code || 'Not configured';
                document.getElementById('displayAccountHolderName').textContent = bankDetails.account_holder_name || 'Not configured';
                document.getElementById('displayBankName').textContent = bankDetails.bank_name || 'Not configured';
            } else {
                document.getElementById('displayAccountNumber').textContent = 'Not configured';
                document.getElementById('displayIfscCode').textContent = 'Not configured';
                document.getElementById('displayAccountHolderName').textContent = 'Not configured';
                document.getElementById('displayBankName').textContent = 'Not configured';
            }
        } else {
            document.getElementById('displayAccountNumber').textContent = 'Error loading details';
            document.getElementById('displayIfscCode').textContent = 'Error loading details';
            document.getElementById('displayAccountHolderName').textContent = 'Error loading details';
            document.getElementById('displayBankName').textContent = 'Error loading details';
        }
    } catch (error) {
        console.error('Error loading bank details:', error);
        document.getElementById('displayAccountNumber').textContent = 'Error loading details';
        document.getElementById('displayIfscCode').textContent = 'Error loading details';
        document.getElementById('displayAccountHolderName').textContent = 'Error loading details';
        document.getElementById('displayBankName').textContent = 'Error loading details';
    }
}

// Load USDT wallet details for display in withdraw modal
async function loadUSDTWalletDetails() {
    console.log('🚀 loadUSDTWalletDetails called');
    
    try {
        // Check if elements exist
        const networkDisplay = document.getElementById('displayUSDTNetwork');
        const walletAddressDisplay = document.getElementById('displayUSDTAddress');
        
        console.log('🔍 Elements found:', { networkDisplay: !!networkDisplay, walletAddressDisplay: !!walletAddressDisplay });
        
        if (!networkDisplay || !walletAddressDisplay) {
            console.error('USDT display elements not found');
            return;
        }
        
        // Make API call
        const response = await apiRequest('/api/v1/usdt-details/', {
            method: 'GET'
        });
        
        console.log('🔍 API Response:', response.status, response.ok);
        
        if (response.ok) {
            const usdtDetails = await response.json();
            console.log('🔍 USDT Details:', usdtDetails);
            
            // Handle paginated response structure
            const detailsArray = usdtDetails.results || usdtDetails;
            console.log('🔍 Details Array:', detailsArray);
            
            if (detailsArray && detailsArray.length > 0) {
                const usdtDetail = detailsArray[0];
                
                // Format network name
                let networkName = usdtDetail.network;
                if (networkName === 'erc20') networkName = 'ERC20 (Ethereum)';
                else if (networkName === 'bep20') networkName = 'BEP20 (Binance Smart Chain)';
                else if (networkName === 'trc20') networkName = 'TRC20 (Tron)';
                
                // Update display fields
                networkDisplay.textContent = networkName || 'Not configured';
                walletAddressDisplay.textContent = usdtDetail.wallet_address || 'Not configured';
                
                console.log('✅ USDT details updated successfully');
                console.log('✅ Network:', networkName);
                console.log('✅ Wallet Address:', usdtDetail.wallet_address);
            } else {
                networkDisplay.textContent = 'Not configured';
                walletAddressDisplay.textContent = 'Not configured';
                console.log('⚠️ No USDT details found in results array');
            }
        } else {
            networkDisplay.textContent = 'Error loading details';
            walletAddressDisplay.textContent = 'Error loading details';
            console.log('❌ API call failed');
        }
    } catch (error) {
        console.error('Error loading USDT wallet details:', error);
        const networkDisplay = document.getElementById('displayUSDTNetwork');
        const walletAddressDisplay = document.getElementById('displayUSDTAddress');
        
        if (networkDisplay) networkDisplay.textContent = 'Error loading details';
        if (walletAddressDisplay) walletAddressDisplay.textContent = 'Error loading details';
    }
}

// Wallet address generation removed - addresses are auto-created during registration

// Display Update Functions
function updateInvestmentsDisplay(investments) {
    const container = document.getElementById('user-investments');
    
    if (investments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="material-icons-outlined fs-1">trending_up</i>
                <h5>No Active Investments</h5>
                <p>Start investing to see your portfolio here</p>
                <button class="btn btn-primary" onclick="window.location.href='/plans/'">
                    <i class="material-icons-outlined me-1">add_circle</i>View Investment Plans
                </button>
            </div>
        `;
        return;
    }
    
    let html = '';
    investments.forEach(investment => {
                                        const statusClass = investment.status?.toLowerCase() === 'active' ? 'success' : 
                    investment.status?.toLowerCase() === 'cancelled' ? 'danger' : 'secondary';
        
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">${investment.plan_name || 'Investment Plan'}</h6>
                        <span class="badge bg-${statusClass}">${investment.status}</span>
                    </div>
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Amount</small>
                            <div class="fw-bold">₹${parseFloat(investment.amount || 0).toFixed(2)}</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">ROI</small>
                            <div class="fw-bold text-success">${investment.roi_percentage || 0}%</div>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Duration</small>
                            <div class="fw-bold">${investment.duration || 0} days</div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">Started: ${new Date(investment.created_at).toLocaleDateString()}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateTransactionsDisplay(transactions) {
    const container = document.getElementById('transactions-list');
    
    if (transactions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="material-icons-outlined fs-1">receipt</i>
                <h5>No Transactions</h5>
                <p>Your transaction history will appear here</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    transactions.forEach(transaction => {
        const typeClass = transaction.transaction_type === 'DEPOSIT' ? 'success' :
                         transaction.transaction_type === 'WITHDRAWAL' ? 'danger' :
                         transaction.transaction_type === 'INVESTMENT' ? 'primary' :
                         transaction.transaction_type === 'ROI' ? 'info' : 'secondary';
        
        const typeIcon = transaction.transaction_type === 'DEPOSIT' ? 'add_circle' :
                        transaction.transaction_type === 'WITHDRAWAL' ? 'remove_circle' :
                        transaction.transaction_type === 'INVESTMENT' ? 'trending_up' :
                        transaction.transaction_type === 'ROI' ? 'paid' : 'receipt';
        
        html += `
            <div class="card mb-2">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <div class="avatar bg-${typeClass}-bg-opacity-10 me-3">
                                <i class="material-icons-outlined text-${typeClass}">${typeIcon}</i>
                            </div>
                            <div>
                                <div class="fw-semibold">${transaction.transaction_type.replace('_', ' ')}</div>
                                <small class="text-muted">${new Date(transaction.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold text-${typeClass}">
                                ${transaction.transaction_type === 'WITHDRAWAL' ? '-' : '+'}₹${parseFloat(transaction.amount || 0).toFixed(2)}
                            </div>
                            <small class="text-muted">${transaction.currency || 'INR'}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updatePagination(data, containerId) {
    const container = document.getElementById(containerId);
    if (!data.count || data.count <= 10) {
        container.innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(data.count / 10);
    let paginationHtml = '<ul class="pagination">';
    
    if (data.previous) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${currentPage - 1})">Previous</a></li>`;
    }
    
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a>
        </li>`;
    }
    
    if (data.next) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${currentPage + 1})">Next</a></li>`;
    }
    
    paginationHtml += '</ul>';
    container.innerHTML = paginationHtml;
}

function getCurrentPage(url) {
    if (!url) return 1;
    const match = url.match(/[?&]page=(\d+)/);
    return match ? parseInt(match[1]) : 1;
}

// Utility Functions
function copyReferralCode() {
    const code = document.getElementById('referral-code').value;
    copyToClipboard(code);
}

function copyReferralLink() {
    const link = document.getElementById('referral-link').value;
    copyToClipboard(link);
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('Copied to clipboard!');
    }).catch(() => {
        showError('Failed to copy to clipboard');
    });
}

function refreshTransactions() {
    currentPage = 1;
    loadTransactions();
}

function calculateProgress(investment) {
    if (!investment.start_date || !investment.maturity_date) return 0;
    
    const start = new Date(investment.start_date);
    const end = new Date(investment.maturity_date);
    const now = new Date();
    
    const total = end - start;
    const elapsed = now - start;
    
    return Math.min(100, Math.max(0, (elapsed / total) * 100));
}

function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'completed':
        case 'approved':
        case 'success': return 'success';
        case 'pending': return 'warning';
        case 'failed':
        case 'rejected': return 'danger';
        default: return 'secondary';
    }
}

function getTransactionIcon(type) {
    switch(type?.toLowerCase()) {
        case 'deposit': return 'add';
        case 'withdrawal': return 'remove';
        case 'investment': return 'trending_up';
        case 'roi': return 'account_balance';
        case 'referral': return 'share';
        default: return 'swap_horiz';
    }
}

function updatePagination(data, containerId) {
    const container = document.getElementById(containerId);
    if (!data.count || data.count <= 10) {
        container.innerHTML = '';
        return;
    }
    
    const totalPages = Math.ceil(data.count / 10);
    let paginationHtml = '<ul class="pagination">';
    
    if (data.previous) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${currentPage - 1})">Previous</a></li>`;
    }
    
    for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
        paginationHtml += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTransactions(${i})">${i}</a>
        </li>`;
    }
    
    if (data.next) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadTransactions(${currentPage + 1})">Next</a></li>`;
    }
    
    paginationHtml += '</ul>';
    container.innerHTML = paginationHtml;
}

function showKYCAlert(type, message) {
    const container = document.getElementById('kyc-alert-container');
    container.innerHTML = `
        <div class="col-12">
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="material-icons-outlined me-2">
                    ${type === 'success' ? 'check_circle' : type === 'danger' ? 'error' : 'warning'}
                </i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    `;
}

function showSuccess(message) {
    // Create a success toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="material-icons-outlined me-2">check_circle</i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add toast to the page
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function showError(message) {
    // Create an error toast notification
    const toastHtml = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="material-icons-outlined me-2">error</i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add toast to the page
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function createToastContainer() {
    // Create toast container if it doesn't exist
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

function showLoading(message = 'Loading...') {
    // Show a loading indicator
    const loadingHtml = `
        <div id="loading-overlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
             style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
            <div class="card text-center p-4">
                <div class="card-body">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">${message}</p>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', loadingHtml);
}

function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function showTabLoading(tabId) {
    // Map logical IDs to actual DOM element IDs
    const elementIdMap = {
        'investments': 'user-investments',
        'referrals': 'referral-tree', 
        'transactions': 'transactions-list',
        'announcements': 'announcements-list'
    };
    
    const actualId = elementIdMap[tabId] || tabId;
    const tab = document.getElementById(actualId);
    if (tab) {
        const existingContent = tab.innerHTML;
        tab.dataset.originalContent = existingContent;
        tab.innerHTML = `
            <div class="text-center text-muted py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading data...</p>
            </div>
        `;
    }
}

function hideTabLoading(tabId) {
    // Map logical IDs to actual DOM element IDs
    const elementIdMap = {
        'investments': 'user-investments',
        'referrals': 'referral-tree',
        'transactions': 'transactions-list', 
        'announcements': 'announcements-list'
    };
    
    const actualId = elementIdMap[tabId] || tabId;
    const tab = document.getElementById(actualId);
    if (tab && tab.dataset.originalContent) {
        tab.innerHTML = tab.dataset.originalContent;
        delete tab.dataset.originalContent;
    }
}

// Load all data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load user profile and wallet data
    loadUserProfile();
    loadWalletBalances();
    loadWalletAddresses();
    loadKYCStatus();
    
    // Load dashboard tab data
    loadInvestments();
    loadReferralData();
    loadTransactions();
    loadAnnouncements();
    
    // Refresh KYC status every 30 seconds in case admin approves it
    setInterval(loadKYCStatus, 30000);
});



// Production ready withdrawal system


</script>

{% endblock %}
